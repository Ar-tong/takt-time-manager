<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takt Time Manager Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Merge Box */
        .merge-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px;
            width: 180px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .merge-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .merge-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
        }
        .merge-label {
            color: #333;
        }
        .merge-value {
            color: #666;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå */
        .file-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå -->
    <div id="galleryMode"></div>

    <!-- ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å) -->
    <div id="calcMode" style="display: none;">
        <div style="margin: 20px 0;">
<h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Takttime ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü</h2>
            <input type="text" id="fileName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå">
            <button onclick="saveFile()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="closeCalculator()">‚ùå ‡∏õ‡∏¥‡∏î</button>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        
        <label>üïí ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô: <input type="number" id="hours"></label>
        <label>üì¶ Customer need per week: <input type="number" id="customerNeedWeek"></label>
        <label>üìÖ Day of work: <input type="number" id="dayOfWork"></label>
        
        <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
        <textarea id="pasteArea" rows="5" cols="50" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
        <button onclick="pasteData()">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

        <h3>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <table border="1">
            <thead>
                <tr>
                    <th>Station</th><th>Merge</th><th>Runtime</th><th>Use OP</th>
                    <th>Actual OP</th><th>Cycle Time</th><th>Out put</th><th>MIN</th><th>MAX</th>
                </tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>

        <h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü Cycle Time ‡πÅ‡∏•‡∏∞ Takttime</h3>
        <canvas id="mixedChart" width="400" height="200"></canvas>

        <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Merge</h3>
        <div id="mergeInfoContainer" style="display: flex; flex-wrap: wrap; gap: 20px;"></div>
    </div>

    <button onclick="newFile()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</button>

<script>
// ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå
let currentFileKey = null;
let chartInstance = null;

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let stationData = [];
let runtimeData = [];
let mergeData = [];
let actualOPData = {};
let takttime = 0;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå
function newFile() {
    resetAllData();
    document.getElementById('calcMode').style.display = 'block';
    document.getElementById('galleryMode').style.display = 'none';
}

function closeCalculator() {
    document.getElementById('calcMode').style.display = 'none';
    document.getElementById('galleryMode').style.display = 'grid';
}

function saveFile() {
    const fileName = document.getElementById('fileName').value || `file_${Date.now()}`;
    const fileData = {
        fileName,
        hours: parseFloat(document.getElementById("hours").value),
        customerNeedWeek: parseFloat(document.getElementById("customerNeedWeek").value),
        dayOfWork: parseFloat(document.getElementById("dayOfWork").value),
        stationData,
        runtimeData,
        mergeData,
        actualOPData,
        takttime,
        timestamp: new Date().toISOString()
    };

    const key = currentFileKey || `file_${Date.now()}`;
    try {
        localStorage.setItem(key, JSON.stringify(fileData));
    } catch (e) {
        console.error('Local Storage is full or data is too large');
    }
    updateGallery();
    closeCalculator();
}

function updateGallery() {
    const gallery = document.getElementById('galleryMode');
    gallery.innerHTML = '';

    for(let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const fileData = JSON.parse(localStorage.getItem(key));

        const card = document.createElement('div');
        card.className = 'file-card';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = '√ó';
        deleteBtn.onclick = () => deleteFile(key);
        card.appendChild(deleteBtn);

        const title = document.createElement('h3');
        title.textContent = `üìÅ ${fileData.fileName}`;
        card.appendChild(title);

        const takttimeText = document.createElement('p');
        takttimeText.textContent = `Takttime: ${fileData.takttime?.toFixed(2) || 'N/A'}`;
        card.appendChild(takttimeText);

        const timestamp = document.createElement('small');
        timestamp.textContent = new Date(fileData.timestamp).toLocaleDateString();
        card.appendChild(timestamp);

        card.onclick = () => openFile(key);
        gallery.appendChild(card);
    }
}

function deleteFile(key) {
    if(confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        localStorage.removeItem(key);
        updateGallery();
    }
}

function openFile(key) {
    const fileData = JSON.parse(localStorage.getItem(key));
    currentFileKey = key;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
    document.getElementById('fileName').value = fileData.fileName;
    document.getElementById('hours').value = fileData.hours;
    document.getElementById('customerNeedWeek').value = fileData.customerNeedWeek;
    document.getElementById('dayOfWork').value = fileData.dayOfWork;
    
    stationData = fileData.stationData || [];
    runtimeData = fileData.runtimeData || [];
    mergeData = fileData.mergeData || [];
    actualOPData = fileData.actualOPData || {};
    takttime = fileData.takttime || 0;

    updateTable();
    updateCharts();
    document.getElementById('calcMode').style.display = 'block';
    document.getElementById('galleryMode').style.display = 'none';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function calculate() {
    const hours = Math.max(0, parseFloat(document.getElementById("hours").value) || 0);
    const customerNeedWeek = Math.max(0, parseFloat(document.getElementById("customerNeedWeek").value) || 0);
    const dayOfWork = Math.max(1, parseFloat(document.getElementById("dayOfWork").value) || 1);

    const workingTimePerDay = hours * 60;
    const customerNeedPerDay = customerNeedWeek / dayOfWork;
    takttime = customerNeedPerDay > 0 ? workingTimePerDay / customerNeedPerDay : 0;

    updateTable();
    updateCharts();
}

function pasteData() {
    const data = document.getElementById("pasteArea").value;
    const rows = data.split("\n");

    stationData = [];
    runtimeData = [];
    mergeData = [];
    actualOPData = {};

    rows.forEach(row => {
        const cols = row.split("\t");
        if (cols.length >= 4) {
            const station = cols[0].trim();
            const merge = cols[3].trim();
            const runtime = parseFloat(cols[2].trim()) || 0;

            if (station && merge && runtime > 0) {
                stationData.push(station);
                runtimeData.push(runtime);
                mergeData.push(merge);
                actualOPData[merge] = 0;
            }
        }
    });

    calculate();
}

function updateTable() {
    const tableBody = document.getElementById("dataTable");
    tableBody.innerHTML = "";

    const mergedData = mergeData.reduce((acc, key, i) => {
        acc[key] = (acc[key] || 0) + runtimeData[i];
        return acc;
    }, {});

    Object.entries(mergedData).forEach(([key, runtime]) => {
        const useOP = takttime > 0 ? (runtime / takttime) : 0;
        const actualOP = Math.max(0, parseFloat(actualOPData[key]) || 0);
        const cycleTime = actualOP > 0 ? (runtime / actualOP).toFixed(2) : "N/A";
        const output = actualOP > 0 ? Math.round((60 / runtime) * actualOP) : "N/A";
        const min = output !== "N/A" ? Math.round(output / 1.5) : "N/A";
        const max = output !== "N/A" ? Math.round(output * 1.5) : "N/A";

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${key}</td><td>${key}</td><td>${runtime.toFixed(2)}</td>
            <td>${useOP.toFixed(2)}</td>
            <td>
    		<input type="number" step="0.1" value="${actualOP}" 
        	onchange="updateActualOP(event, '${key}')"
        	onclick="event.stopPropagation();" 
       		onfocus="this.select();">
	</td>
            <td>${cycleTime}</td><td>${output}</td><td>${min}</td><td>${max}</td>
        `;
        tableBody.appendChild(row);
    });

    updateMergeInfo();
}

function updateActualOP(event, key) {
    actualOPData[key] = Math.max(0, parseFloat(event.target.value) || 0);
    calculate();
}

function updateCharts() {
    if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
    }

    const mergedData = mergeData.reduce((acc, key, i) => {
        acc[key] = (acc[key] || 0) + runtimeData[i];
        return acc;
    }, {});

    const mergeLabels = Object.keys(mergedData);
    const cycleTimes = mergeLabels.map(key => 
        (mergedData[key] / (actualOPData[key] || takttime)).toFixed(2)
    );

    const ctx = document.getElementById('mixedChart').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: mergeLabels,
            datasets: [
                {
                    label: 'Cycle Time',
                    data: cycleTimes,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)'
                },
                {
                    label: 'Takttime',
                    data: new Array(mergeLabels.length).fill(takttime),
                    borderColor: '#ff6384',
                    type: 'line'
                }
            ]
        }
    });
}

function updateMergeInfo() {
    const container = document.getElementById("mergeInfoContainer");
    container.innerHTML = "";

    const mergedData = mergeData.reduce((acc, key, i) => {
        acc[key] = (acc[key] || 0) + runtimeData[i];
        return acc;
    }, {});

    Object.entries(mergedData).forEach(([key, runtime]) => {
        const actualOP = Math.max(0, parseFloat(actualOPData[key]) || 0);
        const cycleTime = (runtime / (actualOP || takttime)).toFixed(2);
        const output = actualOP > 0 ? Math.round((60 / runtime) * actualOP) : 0;
        const min = Math.round(output / 1.5);
        const max = Math.round(output * 1.5);

        const box = document.createElement('div');
        box.className = 'merge-box';

        const header = document.createElement('div');
        header.className = 'merge-header';
        header.textContent = key;
        box.appendChild(header);

        const ctRow = document.createElement('div');
        ctRow.className = 'merge-row';
        ctRow.innerHTML = `<span class="merge-label">C/T:</span><span class="merge-value">${cycleTime}</span>`;
        box.appendChild(ctRow);

        const opRow = document.createElement('div');
        opRow.className = 'merge-row';
        opRow.innerHTML = `<span class="merge-label">OP:</span><span class="merge-value">${actualOP.toFixed(1)}</span>`;
        box.appendChild(opRow);

        const maxRow = document.createElement('div');
        maxRow.className = 'merge-row';
        maxRow.innerHTML = `<span class="merge-label">MAX:</span><span class="merge-value">${max}</span>`;
        box.appendChild(maxRow);

        const minRow = document.createElement('div');
        minRow.className = 'merge-row';
        minRow.innerHTML = `<span class="merge-label">MIN:</span><span class="merge-value">${min}</span>`;
        box.appendChild(minRow);

        container.appendChild(box);
    });
}

function resetAllData() {
    currentFileKey = null;
    stationData = [];
    runtimeData = [];
    mergeData = [];
    actualOPData = {};
    takttime = 0;
    document.getElementById('fileName').value = '';
    document.getElementById('pasteArea').value = '';
    document.getElementById('dataTable').innerHTML = '';
    document.getElementById('mergeInfoContainer').innerHTML = '';
    if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
    }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
document.addEventListener('DOMContentLoaded', () => updateGallery());
</script>

</body>
</html>
